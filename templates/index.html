<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Messenger</title>

<style>
:root{
  --bg:#f6f7fb;
  --panel:#ffffff;
  --text:#0f172a;
  --border:#e2e8f0;
  --accent:#2563eb;
}

[data-mode="dark"]{
  --bg:#0b1220;
  --panel:#0f172a;
  --text:#e2e8f0;
  --border:#1e293b;
}

[data-theme="green"]{ --accent:#16a34a; } [data-theme="pink"]{ --accent:#db2777; }

body{
  background:var(--bg);
  color:var(--text);
  font-family:sans-serif;
}

.chat{
  height:400px;
  overflow-y:auto;
  border:1px solid var(--border);
  padding:10px;
  background:var(--panel);
}

.msg{ margin:10px 0; }
.right{ text-align:right; }

.bubble{
  display:inline-block;
  padding:8px 12px;
  border-radius:12px;
  background:var(--accent);
  color:white;
}

.left .bubble{
  background:#e2e8f0;
  color:black;
}

.meta{
  font-size:11px;
  opacity:0.6;
}

.date-sep{
  text-align:center;
  font-size:12px;
  margin:10px 0;
  opacity:0.6;
}

.read{
  font-size:10px;
  opacity:0.5;
}
</style>
</head>
<body>

<button onclick="toggleMode()">Toggle Mode</button> <select onchange="setTheme(this.value)">
  <option value="">Blue</option>
  <option value="green">Green</option>
  <option value="pink">Pink</option>
</select>

<div class="chat" id="chat"></div>

<input id="name" placeholder="Name">
<input id="text">
<button onclick="send()">Send</button>

<div id="emojiPicker"></div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const socket = io();
const chat = document.getElementById("chat"); const nameInput = document.getElementById("name"); const textInput = document.getElementById("text");

let lastDate = null;

function formatDate(d){
  return new Date(d).toDateString();
}

function addMessage(msg){
  const msgDate = formatDate(msg.created_at);
  if(msgDate !== lastDate){
    const sep = document.createElement("div");
    sep.className="date-sep";
    sep.textContent=msgDate;
    chat.appendChild(sep);
    lastDate = msgDate;
  }

  const div = document.createElement("div");
  const isMine = msg.name === nameInput.value;
  div.className="msg " + (isMine ? "right" : "left");

  div.innerHTML=`
    <div class="bubble">${msg.text}</div>
    <div class="meta">${msg.name}</div>
    <div class="read" id="read-${msg.id}"></div>
  `;

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;

  if(!isMine){
    socket.emit("read", {message_id: msg.id, reader:nameInput.value});
  }
}

socket.on("history", data=>{
  data.forEach(addMessage);
});

socket.on("chat_message", msg=>{
  addMessage(msg);
});

socket.on("read_update", data=>{
  const el = document.getElementById("read-"+data.message_id);
  if(el) el.textContent="Seen âœ“";
});

function send(){
  socket.emit("chat_message", {
    name:nameInput.value,
    text:textInput.value
  });
  textInput.value="";
}

function toggleMode(){
  const m = document.documentElement.getAttribute("data-mode")==="dark"?"light":"dark";
  document.documentElement.setAttribute("data-mode", m); }

function setTheme(t){
  document.documentElement.setAttribute("data-theme", t); }

/* Emoji Picker */
const emojis = ["ðŸ˜€","ðŸ˜‚","ðŸ˜","ðŸ˜Ž","ðŸ”¥","ðŸ‘","ðŸŽ‰","â¤ï¸"];
const picker = document.getElementById("emojiPicker");
emojis.forEach(e=>{
  const btn = document.createElement("button");
  btn.textContent=e;
  btn.onclick=()=>textInput.value+=e;
  picker.appendChild(btn);
});
</script>

</body>
</html>
